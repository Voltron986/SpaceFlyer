<!DOCTYPE html>
<html>
<head>
    <title>Sideways Spaceship Game</title>
    <style>
        canvas {
            border: 1px solid white;
            background: #000;
            display: none;
        }
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #000;
        }
        #startScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: #000;
            z-index: 1;
        }
        #logo {
            max-width: 50%;
            margin-bottom: 20px;
            animation: zoom 8s ease-in-out infinite;
        }
        @keyframes zoom {
            0%, 100% { transform: scale(0.9); }
            50% { transform: scale(1.1); }
        }
        #startButton, #settingsButton {
            padding: 20px 40px;
            font-size: 24px;
            background-color: #2a7e7a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        #startButton:hover, #settingsButton:hover {
            background-color: #45a049;
        }
        #settingsMenu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 2;
        }
        #controlsMenu {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 3;
        }
        #controlsButton, #godModeToggle, #unlockWeaponsToggle, .difficultyButton {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #2a7e7a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 0;
            display: block;
        }
        #controlToggle {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #2a7e7a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            display: block;
        }
        #controlsButton:hover, #godModeToggle:hover, #unlockWeaponsToggle:hover, #controlToggle:hover, .difficultyButton:hover {
            background-color: #45a049;
        }
        #pauseButton {
            display: none;
            position: fixed;
            bottom: 10px;
            left: 10px;
            padding: 15px 30px;
            font-size: 20px;
            background-color: #2a7e7a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 2;
        }
        #quitButton {
            display: none;
            position: fixed;
            bottom: 10px;
            left: 150px;
            padding: 15px 30px;
            font-size: 20px;
            background-color: #2a7e7a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 2;
        }
        #pauseButton:hover, #quitButton:hover {
            background-color: #45a049;
        }
        #settings {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: white;
            font-family: Arial, sans-serif;
            z-index: 2;
        }
        #uiContainer {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 300px;
            padding: 15px;
            background: linear-gradient(135deg, #1a1a1a, #333);
            border: 2px solid #666;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.3);
            color: #0ff;
            font-family: 'Courier New', Courier, monospace;
            z-index: 1;
            display: none;
        }
        #scoreContainer, #weaponContainer, #healthContainer, #bossHealthContainer {
            margin-bottom: 10px;
        }
        #scoreDisplay {
            font-size: 18px;
            margin-left: 10px;
            color: #0ff;
        }
        #weaponList {
            margin-top: 5px;
        }
        .weaponItem {
            font-size: 16px;
            margin: 5px 0;
            padding: 5px;
            background: #222;
            border: 1px solid #0ff;
            border-radius: 3px;
            cursor: pointer;
        }
        .weaponItem.unlocked:hover {
            background: #333;
        }
        .weaponItem.selected {
            background: #0ff;
            color: #000;
        }
        #healthBarContainer, #bossHealthBarContainer {
            width: 200px;
            height: 25px;
            background: linear-gradient(to bottom, #222, #111);
            border: 2px solid #0ff;
            border-radius: 5px;
            position: relative;
            margin-top: 5px;
            box-shadow: inset 0 0 5px rgba(0, 255, 255, 0.5);
        }
        #healthBar, #bossHealthBar {
            height: 100%;
            background: linear-gradient(to right, #00ff00, #00cc00);
            border-radius: 3px;
            transition: width 0.3s;
        }
        #bossHealthBar {
            background: linear-gradient(to right, #ff0000, #cc0000);
        }
        #healthLabel, #bossHealthLabel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <img id="logo" src="logo1.jpg" alt="Game Logo">
        <button id="startButton">Start Game</button>
        <button id="settingsButton">Settings</button>
    </div>
    <div id="settingsMenu">
        <p>Game Settings:</p>
        <button id="controlsButton">Controls</button>
        <button id="godModeToggle">Enable God Mode</button>
        <button id="unlockWeaponsToggle">Unlock All Weapons</button>
        <p>Difficulty:</p>
        <button class="difficultyButton" data-difficulty="easy">Easy</button>
        <button class="difficultyButton" data-difficulty="medium">Medium</button>
        <button class="difficultyButton" data-difficulty="hard">Hard</button>
        <button class="difficultyButton" data-difficulty="superInsane">Super Insane</button>
    </div>
    <div id="controlsMenu">
        <p>Current Controls:</p>
        <p id="movementControls">Movement: WASD</p>
        <p>Shoot: Space</p>
        <p>Boost: Shift</p>
        <p>Switch Weapon: Q</p>
        <button id="controlToggle">Switch to Arrow Keys</button>
    </div>
    <div id="settings">
        <label for="volume">Volume: </label>
        <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
    </div>
    <button id="pauseButton">Pause</button>
    <button id="quitButton">Quit Game</button>
    <div id="uiContainer">
        <div id="scoreContainer">
            <span>Score:</span>
            <span id="scoreDisplay">0</span>
        </div>
        <div id="weaponContainer">
            <span>Weapons:</span>
            <div id="weaponList"></div>
        </div>
        <div id="healthContainer">
            <span>Health:</span>
            <div id="healthBarContainer">
                <div id="healthBar"></div>
                <span id="healthLabel">100</span>
            </div>
        </div>
        <div id="bossHealthContainer" style="display: none;">
            <span>Boss:</span>
            <div id="bossHealthBarContainer">
                <div id="bossHealthBar"></div>
                <span id="bossHealthLabel">500</span>
            </div>
        </div>
    </div>
    <canvas id="gameCanvas" width="1200" height="800"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        const settingsButton = document.getElementById('settingsButton');
        const difficultyButtons = document.querySelectorAll('.difficultyButton');
        const settingsMenu = document.getElementById('settingsMenu');
        const controlsButton = document.getElementById('controlsButton');
        const controlsMenu = document.getElementById('controlsMenu');
        const controlToggle = document.getElementById('controlToggle');
        const movementControls = document.getElementById('movementControls');
        const godModeToggle = document.getElementById('godModeToggle');
        const unlockWeaponsToggle = document.getElementById('unlockWeaponsToggle');
        const pauseButton = document.getElementById('pauseButton');
        const quitButton = document.getElementById('quitButton');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const weaponList = document.getElementById('weaponList');
        const volumeControl = document.getElementById('volume');
        const uiContainer = document.getElementById('uiContainer');
        const healthBarContainer = document.getElementById('healthBarContainer');
        const healthBar = document.getElementById('healthBar');
        const healthLabel = document.getElementById('healthLabel');
        const bossHealthBarContainer = document.getElementById('bossHealthContainer');
        const bossHealthBar = document.getElementById('bossHealthBar');
        const bossHealthLabel = document.getElementById('bossHealthLabel');
        const startScreen = document.getElementById('startScreen');

        const spaceshipImage = new Image();
        spaceshipImage.src = 'ship1.png';
        const enemyImage = new Image();
        enemyImage.src = 'enemy1.png';
        const bossImage = new Image();
        bossImage.src = 'boss.png';

        const laserSound = new Audio('laser.mp3');
        const missileSound = new Audio('missile.mp3');
        const plasmaSound = new Audio('plasma.mp3');
        const boostSound = new Audio('boost.mp3');
        const explosionSound = new Audio('explosion.mp3');
        const backgroundMusic = new Audio('background.mp3');
        const startMusic = new Audio('start_music.mp3');
        backgroundMusic.loop = true;
        startMusic.loop = true;

        const sounds = [laserSound, missileSound, plasmaSound, boostSound, explosionSound, backgroundMusic, startMusic];
        function updateVolume() {
            const volume = parseFloat(volumeControl.value);
            const scaledVolume = volume * volume;
            sounds.forEach(sound => sound.volume = scaledVolume);
            laserSound.volume = scaledVolume * 0.9;
        }
        volumeControl.addEventListener('input', updateVolume);
        updateVolume();

        let score = 0;
        let gameStarted = false;
        let gamePaused = false;
        let aiMode = false;
        let boss = null;
        let weaponSwitchTimer = 0;
        let aiBoostDuration = 0;
        let autoStartTimer = null;
        let useArrowKeys = false;
        let godMode = false;
        let unlockAllWeapons = false;
        let nextBossScore = 1000;
        let difficulty = 'medium'; // Default difficulty

        const spaceship = {
            x: 100,
            y: canvas.height / 2,
            width: 60,
            height: 30,
            speed: 5,
            maxSpeed: 10,
            boostSpeed: 50,
            acceleration: 0.125,
            friction: 0.01,
            weaponCooldown: 0,
            boostTimer: 0,
            boostExhaustionTimer: 0,
            baseX: 100,
            shieldTimer: 0,
            speedBoostTimer: 0,
            health: 100,
            weaponPowerTimer: 0
        };

        const weapons = [
            { name: 'Laser', cooldown: 5, color: 'red', score: 10, unlocked: true },
            { name: 'Missile', cooldown: 30, color: 'orange', score: 25, unlocked: false },
            { name: 'Plasma', cooldown: 15, color: 'purple', score: 15, unlocked: false },
            { name: 'Super', cooldown: 60, color: 'blue', score: 50, unlocked: false }
        ];
        let currentWeapon = 0;

        const projectiles = [];
        const enemies = [];
        const particles = [];
        const stars = [];
        const powerUps = [];
        const numStars = 190;
        const baseStarSpeed = 0.600;

        for (let i = 0; i < numStars; i++) {
            const size = Math.random() * 1.5 + 0.3;
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: size,
                speed: (size * 0.5 + 0.3) * 1.25,
                color: Math.random() < 0.3 ? 'lightblue' : 'white'
            });
        }

        let keys = {
            w: false, a: false, s: false, d: false, space: false, shift: false, q: false,
            ArrowUp: false, ArrowLeft: false, ArrowDown: false, ArrowRight: false
        };

        function tryPlayStartMusic() {
            startMusic.currentTime = 0;
            startMusic.play().catch(e => {
                console.error('Start music blocked:', e);
                setTimeout(tryPlayStartMusic, 1000);
            });
        }
        startMusic.addEventListener('loadeddata', tryPlayStartMusic);

        autoStartTimer = setTimeout(() => {
            if (!gameStarted) {
                aiMode = true;
                startGame();
            }
        }, 30000);

        startButton.addEventListener('click', () => {
            clearTimeout(autoStartTimer);
            startMusic.pause();
            startMusic.currentTime = 0;
            aiMode = false;
            startGame();
        });

        settingsButton.addEventListener('click', () => {
            settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
            godModeToggle.textContent = godMode ? 'Disable God Mode' : 'Enable God Mode';
            unlockWeaponsToggle.textContent = unlockAllWeapons ? 'Lock All Weapons' : 'Unlock All Weapons';
        });

        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                difficulty = button.getAttribute('data-difficulty');
                settingsMenu.style.display = 'none'; // Close settings menu after selection
            });
        });

        controlsButton.addEventListener('click', () => {
            controlsMenu.style.display = 'block';
            settingsMenu.style.display = 'none';
            movementControls.textContent = `Movement: ${useArrowKeys ? 'Arrow Keys' : 'WASD'}`;
        });

        controlToggle.addEventListener('click', () => {
            useArrowKeys = !useArrowKeys;
            movementControls.textContent = `Movement: ${useArrowKeys ? 'Arrow Keys' : 'WASD'}`;
            controlToggle.textContent = useArrowKeys ? 'Switch to WASD' : 'Switch to Arrow Keys';
            controlsMenu.style.display = 'none';
        });

        godModeToggle.addEventListener('click', () => {
            godMode = !godMode;
            godModeToggle.textContent = godMode ? 'Disable God Mode' : 'Enable God Mode';
            if (gameStarted && godMode) {
                spaceship.health = 100;
                healthBar.style.width = '100%';
                healthLabel.textContent = '100';
            }
            settingsMenu.style.display = 'none';
        });

        unlockWeaponsToggle.addEventListener('click', () => {
            unlockAllWeapons = !unlockAllWeapons;
            unlockWeaponsToggle.textContent = unlockAllWeapons ? 'Lock All Weapons' : 'Unlock All Weapons';
            if (unlockAllWeapons) {
                weapons.forEach(weapon => weapon.unlocked = true);
            } else {
                weapons.forEach((weapon, index) => {
                    weapon.unlocked = index === 0 || (score >= 500 && index === 1) || (score >= 1000 && index === 2) || (score >= 1500 && index === 3);
                });
            }
            updateWeaponList();
            settingsMenu.style.display = 'none';
        });

        pauseButton.addEventListener('click', () => {
            gamePaused = !gamePaused;
            pauseButton.textContent = gamePaused ? 'Start' : 'Pause';
            quitButton.style.display = gamePaused ? 'block' : 'none';
            if (!gamePaused) gameLoop();
            if (aiMode) {
                startMusic[gamePaused ? 'pause' : 'play']();
            } else {
                backgroundMusic[gamePaused ? 'pause' : 'play']();
            }
        });

        quitButton.addEventListener('click', () => {
            resetGame();
        });

        canvas.addEventListener('click', () => {
            if (aiMode && gameStarted && !gamePaused) {
                resetGame();
            }
        });

        function startGame() {
            gameStarted = true;
            startScreen.style.display = 'none';
            settingsMenu.style.display = 'none';
            controlsMenu.style.display = 'none';
            canvas.style.display = 'block';
            uiContainer.style.display = 'block';
            healthBarContainer.style.display = 'block';
            pauseButton.style.display = 'block';
            quitButton.style.display = gamePaused ? 'block' : 'none';
            if (unlockAllWeapons) {
                weapons.forEach(weapon => weapon.unlocked = true);
            }
            updateWeaponList();
            if (aiMode) {
                startMusic.play();
            } else {
                backgroundMusic.currentTime = 0;
                backgroundMusic.play();
            }
            gameLoop();
        }

        document.addEventListener('keydown', (e) => {
            if (!gameStarted) return;
            if (!useArrowKeys) {
                if (e.key === 'w' || e.key === 'W') keys.w = true;
                if (e.key === 's' || e.key === 'S') keys.s = true;
                if (e.key === 'd' || e.key === 'D') keys.d = true;
                if (e.key === 'a' || e.key === 'A') keys.a = true;
            } else {
                if (e.key === 'ArrowUp') keys.ArrowUp = true;
                if (e.key === 'ArrowDown') keys.ArrowDown = true;
                if (e.key === 'ArrowRight') keys.ArrowRight = true;
                if (e.key === 'ArrowLeft') keys.ArrowLeft = true;
            }
            if (e.key === ' ') keys.space = true;
            if (e.key === 'Shift') {
                keys.shift = true;
                if (!gamePaused && spaceship.boostExhaustionTimer <= 0) {
                    boostSound.currentTime = 0;
                    boostSound.play();
                }
            }
            if (e.key === 'q' || e.key === 'Q') keys.q = true;
        });

        document.addEventListener('keyup', (e) => {
            if (!gameStarted) return;
            if (!useArrowKeys) {
                if (e.key === 'w' || e.key === 'W') keys.w = false;
                if (e.key === 's' || e.key === 'S') keys.s = false;
                if (e.key === 'd' || e.key === 'D') keys.d = false;
                if (e.key === 'a' || e.key === 'A') keys.a = false;
            } else {
                if (e.key === 'ArrowUp') keys.ArrowUp = false;
                if (e.key === 'ArrowDown') keys.ArrowDown = false;
                if (e.key === 'ArrowRight') keys.ArrowRight = false;
                if (e.key === 'ArrowLeft') keys.ArrowLeft = false;
            }
            if (e.key === ' ') keys.space = false;
            if (e.key === 'Shift') {
                keys.shift = false;
                spaceship.boostTimer = 0;
            }
            if (e.key === 'q' || e.key === 'Q') keys.q = false;
        });

        function spawnEnemy() {
            if (score < 2000 || !boss) {
                let swarmChance, lingerChance, count, spawnIntervalAdjust;
                switch (difficulty) {
                    case 'easy':
                        swarmChance = 0.05;
                        lingerChance = 0.05;
                        count = swarmChance > Math.random() ? 2 : 1;
                        spawnIntervalAdjust = 90;
                        break;
                    case 'medium':
                        swarmChance = 0.1;
                        lingerChance = 0.1;
                        count = swarmChance > Math.random() ? Math.floor(Math.random() * 2) + 3 : 1;
                        spawnIntervalAdjust = 60;
                        break;
                    case 'hard':
                        swarmChance = 0.15;
                        lingerChance = 0.15;
                        count = swarmChance > Math.random() ? Math.floor(Math.random() * 3) + 4 : 1;
                        spawnIntervalAdjust = 45;
                        break;
                    case 'superInsane':
                        swarmChance = 0.3;
                        lingerChance = 0.5;
                        count = swarmChance > Math.random() ? Math.floor(Math.random() * 5) + 6 : 3;
                        spawnIntervalAdjust = 30;
                        break;
                }

                for (let i = 0; i < count; i++) {
                    const isHeatSeeker = (difficulty === 'superInsane' && Math.random() < 0.1);
                    const enemy = score < 1000 ? {
                        x: canvas.width + i * 40,
                        y: Math.random() * (canvas.height - 20),
                        size: 30,
                        speed: (2 + Math.random() * 2) * (difficulty === 'easy' ? 0.8 : difficulty === 'hard' ? 1.2 : difficulty === 'superInsane' ? 1.5 : 1),
                        targetY: spaceship.y,
                        speedVariationTimer: 0,
                        speedVariationInterval: 60,
                        damage: difficulty === 'easy' ? 5 : difficulty === 'medium' ? 10 : difficulty === 'hard' ? 15 : 20,
                        direction: Math.random() < 0.5 ? 1 : -1,
                        waveTimer: 0,
                        crazyFactor: swarmChance > Math.random() ? Math.random() * 2 + 1 : 1,
                        isLingering: (difficulty === 'superInsane' || lingerChance > Math.random()) && i === 0,
                        lingerTimer: (difficulty === 'superInsane' || lingerChance > Math.random()) && i === 0 ? Math.random() * 300 + 300 : 0,
                        laserCooldown: (difficulty === 'superInsane' || lingerChance > Math.random()) && i === 0 ? 180 : 0,
                        isHeatSeeker: isHeatSeeker,
                        heatSeekerCooldown: isHeatSeeker ? 300 : 0
                    } : {
                        x: canvas.width + i * 40,
                        y: Math.random() * (canvas.height / 2),
                        size: 40,
                        speed: (3 + Math.random() * 2) * (difficulty === 'easy' ? 0.8 : difficulty === 'hard' ? 1.2 : difficulty === 'superInsane' ? 1.5 : 1),
                        baseSpeed: (3 + Math.random() * 2) * (difficulty === 'easy' ? 0.8 : difficulty === 'hard' ? 1.2 : difficulty === 'superInsane' ? 1.5 : 1),
                        moveTimer: 0,
                        moveInterval: 30,
                        damage: difficulty === 'easy' ? 10 : difficulty === 'medium' ? 15 : difficulty === 'hard' ? 20 : 25,
                        direction: Math.random() < 0.5 ? 1 : -1,
                        waveTimer: 0,
                        crazyFactor: swarmChance > Math.random() ? Math.random() * 2 + 1 : 1,
                        isLingering: (difficulty === 'superInsane' || lingerChance > Math.random()) && i === 0,
                        lingerTimer: (difficulty === 'superInsane' || lingerChance > Math.random()) && i === 0 ? Math.random() * 300 + 300 : 0,
                        laserCooldown: (difficulty === 'superInsane' || lingerChance > Math.random()) && i === 0 ? 180 : 0,
                        isHeatSeeker: isHeatSeeker,
                        heatSeekerCooldown: isHeatSeeker ? 300 : 0
                    };
                    enemies.push(enemy);
                }
                spawnInterval = spawnIntervalAdjust;
            }
        }

        let bossSpawned = false;
        function spawnBoss() {
            boss = {
                x: canvas.width - 150,
                y: canvas.height / 2,
                width: 100,
                height: 80,
                health: 500 * (difficulty === 'easy' ? 0.5 : difficulty === 'medium' ? 1 : difficulty === 'hard' ? 1.5 : 2),
                maxHealth: 500 * (difficulty === 'easy' ? 0.5 : difficulty === 'medium' ? 1 : difficulty === 'hard' ? 1.5 : 2),
                laserCooldown: 0,
                damage: 20 * (difficulty === 'easy' ? 0.5 : difficulty === 'medium' ? 1 : difficulty === 'hard' ? 1.5 : 2)
            };
            bossHealthBarContainer.style.display = 'block';
            bossSpawned = true;
        }

        function createExplosion(x, y, size = 2) {
            for (let i = 0; i < 20; i++) {
                const color = Math.random() < 0.5 ? 'yellow' : Math.random() < 0.5 ? 'orange' : 'red';
                particles.push({
                    x: x,
                    y: y,
                    size: Math.random() * size + 0.5,
                    speedX: (Math.random() - 0.5) * 4,
                    speedY: (Math.random() - 0.5) * 4,
                    life: Math.random() * 20 + 10,
                    color: color
                });
            }
        }

        function spawnPowerUp(x, y) {
            if (Math.random() < 0.15) {
                const types = [
                    { type: 'speed', color: 'cyan', effect: () => spaceship.speedBoostTimer = 300 },
                    { type: 'shield', color: 'blue', effect: () => spaceship.shieldTimer = 600 },
                    { type: 'score', color: 'gold', effect: () => score += 100 },
                    { type: 'weapon', color: 'purple', effect: unlockNextWeapon },
                    { type: 'laserPower', color: 'pink', effect: () => { if (weapons[0].unlocked) spaceship.weaponPowerTimer = 300; } },
                    { type: 'missilePower', color: 'yellow', effect: () => { if (weapons[1].unlocked) spaceship.weaponPowerTimer = 300; } },
                    { type: 'plasmaPower', color: 'magenta', effect: () => { if (weapons[2].unlocked) spaceship.weaponPowerTimer = 300; } },
                    { type: 'superPower', color: 'lime', effect: () => { if (weapons[3].unlocked) spaceship.weaponPowerTimer = 300; } }
                ];
                const powerUp = types[Math.floor(Math.random() * types.length)];
                powerUps.push({
                    x: x,
                    y: y,
                    size: 15,
                    speed: 2,
                    type: powerUp.type,
                    color: powerUp.color,
                    effect: powerUp.effect
                });
            }
        }

        function unlockNextWeapon() {
            for (let i = 0; i < weapons.length; i++) {
                if (!weapons[i].unlocked) {
                    weapons[i].unlocked = true;
                    updateWeaponList();
                    break;
                }
            }
        }

        function updateWeaponList() {
            weaponList.innerHTML = '';
            weapons.forEach((weapon, index) => {
                const div = document.createElement('div');
                div.className = `weaponItem ${weapon.unlocked ? 'unlocked' : ''} ${index === currentWeapon ? 'selected' : ''}`;
                div.textContent = weapon.name;
                if (weapon.unlocked) {
                    div.addEventListener('click', () => {
                        currentWeapon = index;
                        updateWeaponList();
                    });
                }
                weaponList.appendChild(div);
            });
        }

        let spawnTimer = 0;
        let spawnInterval = 60;

        function aiControl() {
            if (aiMode && !gamePaused) {
                let targetY;
                if (boss) {
                    if (weapons[0].unlocked && currentWeapon !== 0) {
                        currentWeapon = 0;
                        updateWeaponList();
                    }
                    targetY = boss.y;
                } else {
                    const nearestEnemy = enemies.length > 0 
                        ? enemies.reduce((closest, enemy) => {
                            const dist = Math.abs(enemy.y - spaceship.y);
                            return dist < Math.abs(closest.y - spaceship.y) ? enemy : closest;
                        }, { y: canvas.height / 2 })
                        : { y: canvas.height / 2 };
                    targetY = nearestEnemy.y + (Math.sin(Date.now() * 0.002) * 100);
                }

                if (spaceship.y < targetY - 40) {
                    keys.s = true;
                    keys.w = false;
                } else if (spaceship.y > targetY + 40) {
                    keys.w = true;
                    keys.s = false;
                } else {
                    keys.w = false;
                    keys.s = false;
                }

                keys.d = true;
                if (aiBoostDuration > 0) {
                    keys.shift = true;
                    aiBoostDuration--;
                } else if (Math.random() < 0.05 && spaceship.boostExhaustionTimer <= 0) {
                    keys.shift = true;
                    aiBoostDuration = 60;
                    boostSound.currentTime = 0;
                    boostSound.play();
                } else {
                    keys.shift = false;
                }
                if (spaceship.x > canvas.width * 0.75 && Math.random() < 0.1) {
                    keys.d = false;
                    keys.a = true;
                } else {
                    keys.a = false;
                }

                keys.space = boss ? Math.random() < 0.5 : Math.random() < 0.05;

                weaponSwitchTimer++;
                if (weaponSwitchTimer >= 10800 && !boss) {
                    let nextWeapon = (currentWeapon + 1) % weapons.length;
                    while (!weapons[nextWeapon].unlocked) {
                        nextWeapon = (nextWeapon + 1) % weapons.length;
                    }
                    currentWeapon = nextWeapon;
                    updateWeaponList();
                    weaponSwitchTimer = 0;
                }
            }
        }

        function resetGame() {
            gameStarted = false;
            gamePaused = false;
            if (aiMode) {
                startMusic.pause();
            } else {
                backgroundMusic.pause();
            }
            canvas.style.display = 'none';
            uiContainer.style.display = 'none';
            pauseButton.style.display = 'none';
            quitButton.style.display = 'none';
            settingsMenu.style.display = 'none';
            controlsMenu.style.display = 'none';
            startScreen.style.display = 'flex';
            score = 0;
            spaceship.x = 100;
            spaceship.y = canvas.height / 2;
            spaceship.health = 100;
            enemies.length = 0;
            projectiles.length = 0;
            particles.length = 0;
            powerUps.length = 0;
            boss = null;
            bossSpawned = false;
            nextBossScore = 1000;
            currentWeapon = 0;
            difficulty = 'medium'; // Reset to default
            if (!unlockAllWeapons) {
                weapons[1].unlocked = false;
                weapons[2].unlocked = false;
                weapons[3].unlocked = false;
            }
            updateWeaponList();
            scoreDisplay.textContent = `${score}`;
            healthBar.style.width = '100%';
            healthLabel.textContent = '100';
            bossHealthBarContainer.style.display = 'none';
            tryPlayStartMusic();
            clearTimeout(autoStartTimer);
            autoStartTimer = setTimeout(() => {
                if (!gameStarted) {
                    aiMode = true;
                    startGame();
                }
            }, 30000);
        }

        function update() {
            if (!gameStarted || gamePaused) return;

            if (!aiMode && !godMode && spaceship.health <= 0) {
                backgroundMusic.pause();
                if (confirm('Game Over! Final Score: ' + score + '\nClick OK to return to start screen.')) {
                    resetGame();
                }
                return;
            }

            aiControl();

            if (!unlockAllWeapons) {
                if (score >= 500 && !weapons[1].unlocked) {
                    weapons[1].unlocked = true;
                    updateWeaponList();
                }
                if (score >= 1000 && !weapons[2].unlocked) {
                    weapons[2].unlocked = true;
                    updateWeaponList();
                }
                if (score >= 1500 && !weapons[3].unlocked) {
                    weapons[3].unlocked = true;
                    updateWeaponList();
                }
            }

            let upKey = useArrowKeys ? keys.ArrowUp : keys.w;
            let downKey = useArrowKeys ? keys.ArrowDown : keys.s;
            let rightKey = useArrowKeys ? keys.ArrowRight : keys.d;
            let leftKey = useArrowKeys ? keys.ArrowLeft : keys.a;

            let currentMaxSpeed = keys.shift ? spaceship.boostSpeed : spaceship.maxSpeed;
            if (spaceship.speedBoostTimer > 0) {
                currentMaxSpeed *= 1.5;
                spaceship.speedBoostTimer--;
            }
            if ((rightKey || keys.shift) && spaceship.speed < currentMaxSpeed) {
                spaceship.speed += spaceship.acceleration;
            }
            if (leftKey && spaceship.speed > 0) {
                spaceship.speed -= spaceship.acceleration * 2;
            } else if (spaceship.speed > 0) {
                spaceship.speed -= spaceship.friction;
            }
            if (spaceship.speed < 0) spaceship.speed = 0;

            if (upKey && spaceship.y > spaceship.height) {
                spaceship.y -= keys.shift ? 3 : 3.75;
            }
            if (downKey && spaceship.y < canvas.height - spaceship.height) {
                spaceship.y += keys.shift ? 5 : 3.75;
            }

            if (keys.shift) {
                spaceship.boostTimer++;
                if (spaceship.boostTimer >= 180) {
                    spaceship.boostExhaustionTimer = 300;
                }
            }
            if (spaceship.boostExhaustionTimer > 0) {
                spaceship.boostExhaustionTimer--;
            }
            if (spaceship.shieldTimer > 0) {
                spaceship.shieldTimer--;
            }
            if (spaceship.weaponPowerTimer > 0) {
                spaceship.weaponPowerTimer--;
            }

            if (keys.shift) {
                if (rightKey && spaceship.x < canvas.width - spaceship.width && spaceship.boostExhaustionTimer <= 0) {
                    spaceship.x += spaceship.speed;
                }
                if (leftKey && spaceship.x > 0) {
                    spaceship.x -= spaceship.speed;
                }
                if (!rightKey && !leftKey && spaceship.x > spaceship.baseX) {
                    spaceship.x -= 2;
                    if (spaceship.x < spaceship.baseX) spaceship.x = spaceship.baseX;
                }
            } else if (spaceship.x > spaceship.baseX) {
                spaceship.x -= 6.25;
                if (spaceship.x < spaceship.baseX) spaceship.x = spaceship.baseX;
            }

            stars.forEach(star => {
                star.x -= baseStarSpeed + (star.speed * spaceship.speed);
                if (star.x < 0) {
                    star.x = canvas.width;
                    star.y = Math.random() * canvas.height;
                }
            });

            if (keys.q && spaceship.weaponCooldown <= 0) {
                let nextWeapon = (currentWeapon + 1) % weapons.length;
                while (!weapons[nextWeapon].unlocked) {
                    nextWeapon = (nextWeapon + 1) % weapons.length;
                }
                currentWeapon = nextWeapon;
                updateWeaponList();
                spaceship.weaponCooldown = 10;
            }

            if (spaceship.weaponCooldown > 0) spaceship.weaponCooldown--;
            if (keys.space && spaceship.weaponCooldown <= 0 && weapons[currentWeapon].unlocked) {
                const weapon = weapons[currentWeapon];
                if (weapon.name === 'Laser') {
                    laserSound.currentTime = 0;
                    laserSound.play();
                    if (spaceship.weaponPowerTimer > 0) {
                        for (let angle = 0; angle < 360; angle += 45) {
                            const rad = angle * Math.PI / 180;
                            projectiles.push({
                                type: 'laser',
                                x: spaceship.x + spaceship.width,
                                y: spaceship.y,
                                speed: 12.5,
                                width: 8,
                                height: 2,
                                color: weapon.color,
                                score: weapon.score,
                                speedX: Math.cos(rad) * 12.5,
                                speedY: Math.sin(rad) * 12.5,
                                fromPlayer: true
                            });
                        }
                    } else {
                        projectiles.push({
                            type: 'laser',
                            x: spaceship.x + spaceship.width,
                            y: spaceship.y,
                            speed: 12.5,
                            width: 8,
                            height: 2,
                            color: weapon.color,
                            score: weapon.score,
                            fromPlayer: true
                        });
                    }
                } else if (weapon.name === 'Missile' && enemies.length > 0) {
                    missileSound.currentTime = 0;
                    missileSound.play();
                    const target1 = enemies[Math.floor(Math.random() * enemies.length)];
                    const target2 = enemies[Math.floor(Math.random() * enemies.length)];
                    projectiles.push({
                        type: 'missile',
                        x: spaceship.x + spaceship.width,
                        y: spaceship.y - 10,
                        speed: spaceship.weaponPowerTimer > 0 ? 12 : 8,
                        size: 6,
                        target: target1,
                        color: weapon.color,
                        score: weapon.score,
                        fromPlayer: true
                    });
                    projectiles.push({
                        type: 'missile',
                        x: spaceship.x + spaceship.width,
                        y: spaceship.y + 10,
                        speed: spaceship.weaponPowerTimer > 0 ? 12 : 8,
                        size: 6,
                        target: target2,
                        color: weapon.color,
                        score: weapon.score,
                        fromPlayer: true
                    });
                } else if (weapon.name === 'Plasma') {
                    plasmaSound.currentTime = 0;
                    plasmaSound.play();
                    projectiles.push({
                        type: 'plasma',
                        x: spaceship.x + spaceship.width,
                        y: spaceship.y,
                        speed: 10,
                        radius: 10,
                        maxRadius: 75,
                        life: 30,
                        color: weapon.color,
                        score: weapon.score,
                        fromPlayer: true
                    });
                } else if (weapon.name === 'Super') {
                    projectiles.push({
                        type: 'super',
                        x: spaceship.x + spaceship.width,
                        y: spaceship.y,
                        speed: spaceship.weaponPowerTimer > 0 ? 20 : 15,
                        radius: 10,
                        maxRadius: 100,
                        life: 30,
                        color: weapon.color,
                        score: weapon.score,
                        fromPlayer: true
                    });
                }
                spaceship.weaponCooldown = weapon.cooldown;
            }

            for (let i = projectiles.length - 1; i >= 0; i--) {
                const proj = projectiles[i];
                if (proj.type === 'laser') {
                    if (proj.speedX !== undefined) {
                        proj.x += proj.speedX;
                        proj.y += proj.speedY;
                    } else {
                        proj.x += proj.speed;
                    }
                } else if (proj.type === 'missile') {
                    if (!proj.target || !enemies.includes(proj.target)) {
                        proj.target = enemies.length > 0 ? enemies[Math.floor(Math.random() * enemies.length)] : null;
                    }
                    if (proj.target) {
                        const dx = proj.target.x - proj.x;
                        const dy = proj.target.y - proj.y;
                        const angle = Math.atan2(dy, dx);
                        proj.x += Math.cos(angle) * proj.speed;
                        proj.y += Math.sin(angle) * proj.speed;
                    } else {
                        proj.x += proj.speed;
                    }
                } else if (proj.type === 'plasma' || proj.type === 'super') {
                    proj.x += proj.speed;
                    proj.radius += 2;
                    proj.life--;
                    if (proj.life <= 0 || proj.x > canvas.width) {
                        if (proj.type === 'plasma' && proj.life <= 0) {
                            createExplosion(proj.x, proj.y, 4);
                            for (let j = enemies.length - 1; j >= 0; j--) {
                                const enemy = enemies[j];
                                const dx = proj.x - (enemy.x + enemy.size / 2);
                                const dy = proj.y - (enemy.y + enemy.size / 2);
                                const distance = Math.sqrt(dx * dx + dy * dy);
                                if (distance < proj.maxRadius + enemy.size / 2) {
                                    enemies.splice(j, 1);
                                    score += proj.score;
                                    scoreDisplay.textContent = `${score}`;
                                }
                            }
                        }
                        projectiles.splice(i, 1);
                        continue;
                    }
                }
                if (proj.type !== 'super' && proj.type !== 'plasma' && (proj.x > canvas.width || proj.x < 0)) {
                    projectiles.splice(i, 1);
                }

                if (!proj.fromPlayer && 
                    proj.x < spaceship.x + spaceship.width &&
                    proj.x + proj.width > spaceship.x &&
                    proj.y < spaceship.y + spaceship.height/2 &&
                    proj.y + proj.height > spaceship.y - spaceship.height/2 &&
                    spaceship.shieldTimer <= 0 && !godMode && !aiMode) {
                    spaceship.health -= 10;
                    healthBar.style.width = `${spaceship.health}%`;
                    healthLabel.textContent = `${Math.max(0, spaceship.health)}`;
                    projectiles.splice(i, 1);
                }
            }

            spawnTimer++;
            if (spawnTimer >= spawnInterval) {
                spawnEnemy();
                spawnTimer = 0;
            }

            if (score >= nextBossScore && !boss && !bossSpawned) {
                spawnBoss();
                nextBossScore += 1000;
            }

            if (boss) {
                boss.y += Math.sin(Date.now() * 0.001) * 2;
                if (boss.y < boss.height) boss.y = boss.height;
                if (boss.y > canvas.height - boss.height) boss.y = canvas.height - boss.height;

                if (boss.laserCooldown <= 0) {
                    projectiles.push({
                        type: 'laser',
                        x: boss.x,
                        y: boss.y,
                        speed: -5,
                        width: 12,
                        height: 4,
                        color: 'green',
                        score: 0,
                        fromPlayer: false
                    });
                    boss.laserCooldown = 30;
                }
                boss.laserCooldown--;

                for (let i = projectiles.length - 1; i >= 0; i--) {
                    const proj = projectiles[i];
                    let hit = false;
                    if (proj.type === 'laser' && 
                        proj.x < boss.x + boss.width &&
                        proj.x + proj.width > boss.x &&
                        proj.y < boss.y + boss.height/2 &&
                        proj.y + proj.height > boss.y - boss.height/2) {
                        hit = true;
                    } else if (proj.type === 'missile' &&
                        proj.x < boss.x + boss.width &&
                        proj.x + proj.size > boss.x &&
                        proj.y < boss.y + boss.height/2 &&
                        proj.y + proj.size > boss.y - boss.height/2) {
                        hit = true;
                    } else if (proj.type === 'plasma' || proj.type === 'super') {
                        const dx = proj.x - (boss.x + boss.width/2);
                        const dy = proj.y - (boss.y);
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < proj.maxRadius + boss.width/2) {
                            hit = true;
                        }
                    }

                    if (hit && proj.fromPlayer) {
                        boss.health -= proj.score;
                        if (proj.type !== 'super' && proj.type !== 'plasma') {
                            projectiles.splice(i, 1);
                        }
                        if (boss.health <= 0) {
                            explosionSound.currentTime = 0;
                            explosionSound.play();
                            createExplosion(boss.x + boss.width/2, boss.y);
                            spawnPowerUp(boss.x + boss.width/2, boss.y);
                            score += 500;
                            scoreDisplay.textContent = `${score}`;
                            bossHealthBarContainer.style.display = 'none';
                            boss = null;
                            bossSpawned = false;
                            if (aiMode) {
                                resetGame();
                            }
                        } else {
                            createExplosion(proj.x, proj.y);
                        }
                        bossHealthBar.style.width = `${(boss.health / boss.maxHealth) * 100}%`;
                        bossHealthLabel.textContent = `${Math.max(0, boss.health)}`;
                    }
                }

                if (spaceship.shieldTimer <= 0 && !godMode &&
                    boss.x < spaceship.x + spaceship.width &&
                    boss.x + boss.width > spaceship.x &&
                    boss.y - boss.height/2 < spaceship.y + spaceship.height/2 &&
                    boss.y + boss.height/2 > spaceship.y - spaceship.height/2) {
                    if (!aiMode) {
                        spaceship.health -= boss.damage;
                        healthBar.style.width = `${spaceship.health}%`;
                        healthLabel.textContent = `${Math.max(0, spaceship.health)}`;
                    }
                }
            }

            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                enemy.waveTimer += 0.05;
                if (enemy.isLingering && enemy.lingerTimer > 0) {
                    enemy.x -= enemy.speed * 0.1;
                    enemy.y += Math.sin(enemy.waveTimer) * 2 * enemy.crazyFactor;
                    enemy.lingerTimer--;
                    if (enemy.laserCooldown <= 0) {
                        projectiles.push({
                            type: 'laser',
                            x: enemy.x,
                            y: enemy.y + enemy.size / 2,
                            speed: -2,
                            width: 8,
                            height: 2,
                            color: 'yellow',
                            score: 0,
                            fromPlayer: false
                        });
                        enemy.laserCooldown = difficulty === 'superInsane' ? 90 : 180;
                    }
                    enemy.laserCooldown--;
                    if (enemy.isHeatSeeker && enemy.heatSeekerCooldown <= 0) {
                        projectiles.push({
                            type: 'missile',
                            x: enemy.x,
                            y: enemy.y + enemy.size / 2,
                            speed: 8,
                            size: 6,
                            target: spaceship,
                            color: 'orange',
                            score: 0,
                            fromPlayer: false
                        });
                        enemy.heatSeekerCooldown = 300;
                    }
                    if (enemy.isHeatSeeker) enemy.heatSeekerCooldown--;
                } else if (score < 1000) {
                    enemy.y += Math.sin(enemy.waveTimer) * 2 * enemy.crazyFactor + (enemy.y < spaceship.y ? 1 : -1);
                    enemy.speedVariationTimer++;
                    if (enemy.speedVariationTimer >= enemy.speedVariationInterval) {
                        enemy.speed = (2 + Math.random() * 2) * 1.25 * enemy.crazyFactor;
                        enemy.speedVariationTimer = 0;
                        if (Math.random() < 0.2) enemy.direction *= -1;
                    }
                    enemy.x -= enemy.speed + (spaceship.speed * 0.2);
                } else {
                    enemy.moveTimer++;
                    if (enemy.moveTimer >= enemy.moveInterval) {
                        enemy.direction = Math.random() < 0.5 ? 1 : -1;
                        enemy.moveTimer = 0;
                    }
                    enemy.y += enemy.direction * 3 * enemy.crazyFactor + Math.sin(enemy.waveTimer) * 3 * enemy.crazyFactor;
                    if (enemy.y < 0 || enemy.y > canvas.height - enemy.size) {
                        enemy.direction *= -1;
                    }
                    enemy.x -= enemy.speed + (spaceship.speed * 0.2);
                    enemy.speed = enemy.baseSpeed + Math.sin(Date.now() * 0.01) * 2 * enemy.crazyFactor;
                }

                if (spaceship.shieldTimer <= 0 && !godMode &&
                    enemy.x < spaceship.x + spaceship.width &&
                    enemy.x + enemy.size > spaceship.x &&
                    enemy.y < spaceship.y + spaceship.height/2 &&
                    enemy.y + enemy.size > spaceship.y - spaceship.height/2) {
                    if (!aiMode) {
                        spaceship.health -= enemy.damage;
                        healthBar.style.width = `${spaceship.health}%`;
                        healthLabel.textContent = `${Math.max(0, spaceship.health)}`;
                    }
                    explosionSound.currentTime = 0;
                    explosionSound.play();
                    createExplosion(enemy.x + enemy.size/2, enemy.y + enemy.size/2);
                    spawnPowerUp(enemy.x + enemy.size/2, enemy.y + enemy.size/2);
                    enemies.splice(i, 1);
                    continue;
                }

                for (let j = projectiles.length - 1; j >= 0; j--) {
                    const proj = projectiles[j];
                    let hit = false;
                    if (proj.type === 'laser' && 
                        proj.x < enemy.x + enemy.size &&
                        proj.x + proj.width > enemy.x &&
                        proj.y < enemy.y + enemy.size &&
                        proj.y + proj.height > enemy.y) {
                        hit = true;
                    } else if (proj.type === 'missile' &&
                        proj.x < enemy.x + enemy.size &&
                        proj.x + proj.size > enemy.x &&
                        proj.y < enemy.y + enemy.size &&
                        proj.y + proj.size > enemy.y) {
                        hit = true;
                    } else if (proj.type === 'plasma' || proj.type === 'super') {
                        const dx = proj.x - (enemy.x + enemy.size/2);
                        const dy = proj.y - (enemy.y + enemy.size/2);
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        if (distance < proj.maxRadius + enemy.size/2) {
                            hit = true;
                        }
                    }

                    if (hit && proj.fromPlayer) {
                        explosionSound.currentTime = 0;
                        explosionSound.play();
                        createExplosion(enemy.x + enemy.size/2, enemy.y + enemy.size/2);
                        spawnPowerUp(enemy.x + enemy.size/2, enemy.y + enemy.size/2);
                        enemies.splice(i, 1);
                        if (proj.type !== 'super' && proj.type !== 'plasma') {
                            projectiles.splice(j, 1);
                        }
                        score += proj.score;
                        scoreDisplay.textContent = `${score}`;
                        break;
                    }
                }

                if (enemy.x < -enemy.size) {
                    enemies.splice(i, 1);
                }
            }

            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                powerUp.x -= powerUp.speed;
                if (powerUp.x < -powerUp.size) {
                    powerUps.splice(i, 1);
                    continue;
                }

                if (powerUp.x < spaceship.x + spaceship.width &&
                    powerUp.x + powerUp.size > spaceship.x &&
                    powerUp.y < spaceship.y + spaceship.height/2 &&
                    powerUp.y + powerUp.size > spaceship.y - spaceship.height/2) {
                    powerUp.effect();
                    powerUps.splice(i, 1);
                }
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                particle.x += particle.speedX;
                particle.y += particle.speedY;
                particle.life--;
                if (particle.life <= 0) {
                    particles.splice(i, 1);
                }
            }

            if (!aiMode) {
                healthBar.style.width = `${spaceship.health}%`;
                healthLabel.textContent = godMode ? '' : `${Math.max(0, spaceship.health)}`;
            } else {
                healthBar.style.width = '100%';
                healthLabel.textContent = '';
            }
        }

        function draw() {
            if (!gameStarted) return;

            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            stars.forEach(star => {
                ctx.fillStyle = star.color;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            });

            ctx.drawImage(spaceshipImage, 
                spaceship.x, 
                spaceship.y - spaceship.height / 2, 
                spaceship.width, 
                spaceship.height
            );

            if (spaceship.shieldTimer > 0 || godMode) {
                ctx.strokeStyle = godMode ? 'gold' : 'blue';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(spaceship.x + spaceship.width / 2, spaceship.y, 25, 0, Math.PI * 2);
                ctx.stroke();
            }

            if (spaceship.speed > 0) {
                const flameLength = spaceship.speed * 2 + (keys.shift ? 20 : 10);
                const flameWidth = (keys.shift ? 15 : 10) + Math.random() * 2;
                const gradient = ctx.createLinearGradient(
                    spaceship.x, spaceship.y,
                    spaceship.x - flameLength, spaceship.y
                );
                gradient.addColorStop(0, 'rgba(255, 255, 0, 1)');
                gradient.addColorStop(0.3, 'rgba(255, 165, 0, 1)');
                gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');

                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.moveTo(spaceship.x, spaceship.y);
                ctx.quadraticCurveTo(
                    spaceship.x - flameLength * 0.7, spaceship.y - flameWidth / 2,
                    spaceship.x - flameLength, spaceship.y
                );
                ctx.quadraticCurveTo(
                    spaceship.x - flameLength * 0.7, spaceship.y + flameWidth / 2,
                    spaceship.x, spaceship.y
                );
                ctx.closePath();
                ctx.fill();
            }

            projectiles.forEach(proj => {
                ctx.fillStyle = proj.color;
                if (proj.type === 'laser') {
                    ctx.fillRect(proj.x, proj.y - proj.height / 2, proj.width, proj.height);
                } else if (proj.type === 'missile') {
                    ctx.beginPath();
                    ctx.moveTo(proj.x, proj.y - proj.size / 2);
                    ctx.lineTo(proj.x + proj.size, proj.y);
                    ctx.lineTo(proj.x, proj.y + proj.size / 2);
                    ctx.closePath();
                    ctx.fill();
                } else if (proj.type === 'plasma' || proj.type === 'super') {
                    ctx.beginPath();
                    ctx.arc(proj.x, proj.y, proj.radius, 0, Math.PI * 2);
                    ctx.fillStyle = `${proj.color}${proj.type === 'plasma' ? '80' : Math.floor(proj.life / 30 * 255).toString(16)}`;
                    ctx.fill();
                }
            });

            enemies.forEach(enemy => {
                ctx.drawImage(enemyImage, 
                    enemy.x, 
                    enemy.y - enemy.size / 2, 
                    enemy.size, 
                    enemy.size
                );
            });

            if (boss) {
                ctx.drawImage(bossImage, 
                    boss.x, 
                    boss.y - boss.height / 2, 
                    boss.width, 
                    boss.height
                );
            }

            powerUps.forEach(powerUp => {
                ctx.fillStyle = powerUp.color;
                ctx.beginPath();
                ctx.arc(powerUp.x, powerUp.y, powerUp.size / 2, 0, Math.PI * 2);
                ctx.fill();
            });

            particles.forEach(particle => {
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
            });

            if (gamePaused) {
                ctx.fillStyle = 'white';
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Paused', canvas.width / 2, canvas.height / 2);
            }
        }

        function gameLoop() {
            if (!gamePaused) {
                update();
            }
            draw();
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
